define(["require","underscore","backbone","mustache","lib/BrowserUtil","module/agent/MainContentAgent","module/agent/HomePageAgent","module/agent/SettingPageAgent","module/component/StatusCodeManager","module/interface/LeftCanvas","module/interface/HomePage","module/interface/FileManagePage","module/interface/SettingPage","module/interface/HelpPage","module/interface/LogoutPage","module/interface/kit/AlertBox","module/GlobalVar","text!../../../html/MainContent.html","text!../../../html/WebCamera.html"],function(e){"use strict";function b(){this._activePage=null,this._leftCanvas=null,this._pageSet=[],this._init()}var t=e("underscore"),n=e("backbone"),r=e("mustache"),i=e("lib/BrowserUtil"),s=e("module/agent/MainContentAgent"),o=e("module/agent/HomePageAgent"),u=e("module/agent/SettingPageAgent"),a=e("module/component/StatusCodeManager"),f=e("module/interface/LeftCanvas"),l=e("module/interface/HomePage"),c=e("module/interface/FileManagePage"),h=e("module/interface/SettingPage"),p=e("module/interface/HelpPage"),d=e("module/interface/LogoutPage"),v=e("module/interface/kit/AlertBox"),m=e("module/GlobalVar"),g=e("text!../../../html/MainContent.html"),y=e("text!../../../html/WebCamera.html");return t.extend(b.prototype,n.Events),b.prototype._init=function(){this._initPage(),this._initCentreContent(),this._initLeftCanvas(),this._initEvent(),this._initTimer()},b.prototype._initLeftCanvas=function(){this._leftCanvas=new f},b.prototype._initCentreContent=function(){this._pageSet.push(new l),this._pageSet.push(new c),this._pageSet.push(new h),this._pageSet.push(new p),this._pageSet.push(new d)},b.prototype._initPage=function(){m.isMobile=i.isMobile();var e=m.language.MainContent;$("#content").html(r.render(g,{PageCameraText:e.Camera,TakePhotoText:e.TakePhoto,StopText:e.Stop,leftCanvasContent:f.prototype.getContent(),centreContent:[l.prototype.getContent(),c.prototype.getContent(),h.prototype.getContent(),p.prototype.getContent(),d.prototype.getContent()]}))},b.prototype._initEvent=function(){this._bindEvent(),this.on("activePage",function(e){for(var t=0,n=this._pageSet.length;t<n;++t){if(this._pageSet[t].INDEX===e){this._pageSet[t].trigger("active"),this._activePage=this._pageSet[t];continue}this._pageSet[t].trigger("deactive")}})},b.prototype._bindEvent=function(){$("#toggleAsideButton").click(function(e){i.stopPropagation(e),$("body").hasClass("aside-toggled")?$("body").removeClass("aside-toggled"):$("body").addClass("aside-toggled")}),$("#openCameraButton").click(function(e){i.stopPropagation(e),$("#mainModalContent").html(y),s.queryPage("webcam",function(e){$("#mainModal").modal("show")},function(e){$("#mainModalContent").html(a.getErrorMessage(e.status)),$("#mainModal").modal("show")})}),$("#takePhotoButton").click(function(e){i.stopPropagation(e),s.queryPage("take-photo",function(e){typeof e=="string"&&(e=JSON.parse(e));if(!a.isOK(e.code)){var t=new v(a.getErrorMessage(e.code));$("body").append(t.getDiv())}},function(e){var t=new v(a.getErrorMessage(e.status));$("body").append(t.getDiv())})}),$("#closeModalButton").click(function(e){$("#mainModalContent").html(""),null!==m.threejsRenderer&&m.threejsRenderer.disposeModelInScene()}),$("#stopImmediatelyButton").click(function(e){i.stopPropagation(e),s.stopImmediately(function(e){a.isOK(e.code)||self.notifyErrorMessage(e.code)},function(e){var t=new v(a.getErrorMessage(e.status));$("body").append(t.getDiv())})})},b.prototype._initTimer=function(){var e=this,t=this._pageSet[0],n=1e3,r=6e4;this._activePage=t,function i(){o.queryPrint("state",function(e){var r=e.msg;"updating"===r.state&&(window.location.href="waiting-update/"),t.updateStateInfo(r),n=1e3,setTimeout(function(){i()},n*=3)},function(e){var t=new v(a.getErrorMessage(e.status));$("body").append(t.getDiv()),setTimeout(function(){i()},n*=2),n=r<n?1e3:n})}(),setInterval(function(){null!==e._activePage&&e._activePage.trigger("update")},5e3)},b});