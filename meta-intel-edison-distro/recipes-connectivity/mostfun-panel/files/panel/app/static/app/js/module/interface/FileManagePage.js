define(["require","mustache","lib/BrowserUtil","lib/DateTimeUtil","lib/InheritHelper","module/ThreejsRenderer","module/component/TemperatureManager","module/component/StatusCodeManager","module/agent/FileManagePageAgent","module/interface/CentreContentPage","module/interface/kit/AlertBox","module/interface/kit/Loader","module/GlobalVar","text!../../../html/FileManagePage.html","text!../../../html/fileManagePage/DropZoneIcon.html","text!../../../html/fileManagePage/fileManageTable/TableHead.html","text!../../../html/fileManagePage/fileManageTable/TableBody.html","text!../../../html/fileManagePage/fileManageOperate/FileOperateModal.html"],function(e){"use strict";function y(){this.superClass(),this._isUploading=!1,this._bindEvent(),this.active()}var t=e("mustache"),n=e("lib/BrowserUtil"),r=e("lib/DateTimeUtil"),i=e("lib/InheritHelper"),s=e("module/ThreejsRenderer"),o=e("module/component/TemperatureManager"),u=e("module/component/StatusCodeManager"),a=e("module/agent/FileManagePageAgent"),f=e("module/interface/CentreContentPage"),l=e("module/interface/kit/AlertBox"),c=e("module/interface/kit/Loader"),h=e("module/GlobalVar"),p=e("text!../../../html/FileManagePage.html"),d=e("text!../../../html/fileManagePage/DropZoneIcon.html"),v=e("text!../../../html/fileManagePage/fileManageTable/TableHead.html"),m=e("text!../../../html/fileManagePage/fileManageTable/TableBody.html"),g=e("text!../../../html/fileManagePage/fileManageOperate/FileOperateModal.html");return i.inheritPrototype(y,f),y.prototype.INDEX=1,y.prototype.active=function(){var e=this;this._getCloudSpaceInfo(),this._refreshTabelHead(),$("#fileTableFooter").html(c.getDiv());if(h.debug){var t=[{fileName:"file1",fileSize:"110",fileContent:"no description",path:1,fileTime:"2015/11/26 12:45",isPC:!h.isMobile},{fileName:"file2",fileSize:"120",fileContent:"test file2",path:2,fileTime:"2015/11/26 3:23",isPC:!h.isMobile}];this.setFileTableBody(JSON.stringify(t));return}a.queryFile("filelist",function(t){e.setFileTableBody(t)},function(t){e.notifyErrorMessage(t.status)})},y.prototype._refreshTabelHead=function(){var e=h.language.FileManagePage;$("#fileTableRow").html(t.render(v,{FileNameText:e.FileName,SizeText:e.Size,DescriptionText:e.Description,UploadDateText:e.UploadDate,OperationText:e.Operation,isPC:!h.isMobile}))},y.prototype.setFileTableBody=function(e){var n=h.language.FileManagePage,i=[],s=e,o=null;for(var u=0,a=s.length;u<a;++u)o=s[u],i.push({name:o.fileName,size:o.fileSize,description:o.fileContent,date:r.getTimeZoneDate(o.fileTime),flag:o.path,source:this._getFileSourceLabel(o.path),OperationButtonText:n.Operation,isPC:!h.isMobile});$("#fileTableFooter").html(""),$("#fileTableBody").html(t.render(m,{fileItems:i})),this._bindOperationButtonEvent();if(!h.isMobile)try{$("#fileTable").DataTable({order:[[4,"desc"]]})}catch(f){console.error(f)}},y.prototype._getFileSourceLabel=function(e){var t="";switch(e){case 0:t="internal";break;case 1:t="SD";break;case 2:t="USB";break;default:t="??"}return t},y.prototype._bindOperationButtonEvent=function(){var e=this;$(".OperationButton").each(function(){$(this).click(function(t){e._onOperationButtonClick(t,$(this).closest("tr").data("filename"),$(this).closest("tr").data("flag"))})})},y.prototype._onOperationButtonClick=function(e,r,i){n.stopPropagation(e);var s=h.language.FileManagePage;$("#mainModalContent").html(t.render(g,{FileManageText:s.FileManage,DeleteButtonText:s.Delete,PreviewButtonText:s.Preview,PrintButtonText:s.Print,FileNameText:r})),this._bindFileOperateModalEvent(r,i),$("#mainModal").modal("show")},y.prototype._bindFileOperateModalEvent=function(e,t){var n=this,r=h.language.AlertBoxError;$("#modal_DeleteFileButton").click(function(r){var i=[{filename:e,path:t}];n._addLoadingProcessAnimation(e),a.operateFiles("/del/",i,function(t){if(u.isOK(t.code)){n.trigger("active");if(-1===$("#mainModalContent").find(".progressFileName").html().indexOf(e))return;$("#mainModal").modal("hide")}else n.notifyErrorMessage(t.code)},function(e){$("#mainModal").modal("hide"),n.notifyErrorMessage(e.status)})}),$("#modal_PreviewFileButton").click(function(r){n._addLoadingProcessAnimation(e);var i=document.createElement("div");$(i).addClass("progressNumber"),$(i).css({"text-align":"center"}),$("#mainModalContent").append(i);if(h.debug){$("#mainModalContent").html(""),null===h.threejsRenderer?(h.threejsRenderer=new s,h.threejsRenderer.init("mainModalContent"),h.threejsRenderer.render()):h.threejsRenderer.changeRenderViewDom("mainModalContent"),$("#mainModal").modal("show");return}var o=e,u={filename:o.replace(".gcode",".stl"),path:t};a.previewFile(u,function(t){if(-1===$("#mainModalContent").find(".progressFileName").html().indexOf(e))return;$("#mainModalContent").html(""),null===h.threejsRenderer?(h.threejsRenderer=new s,h.threejsRenderer.init("mainModalContent"),h.threejsRenderer.render()):h.threejsRenderer.changeRenderViewDom("mainModalContent"),h.threejsRenderer.loadStlModelArrayBuffer(t),$("#mainModal").modal("show")},function(e){n.notifyErrorMessage(e.status)},function(e){$("#mainModalContent").find(".progressNumber").html(Math.round(e.loaded*100/e.total)+"%")})}),$("#modal_PrintFileButton").click(function(r){var i={filename:e,path:t};n._addLoadingProcessAnimation(e);if(h.debug){$("#mainModal").modal("hide"),$(".centreContent").each(function(){$(this).hide()}),window.location.hash="#/home",$("#homePage").fadeIn();return}a.operateFiles("/print/",i,function(e){if(u.isOK(e.code)){var t=e;$("#mainModal").modal("hide"),$(".centreContent").each(function(){$(this).hide()}),window.location.hash="#/home",h.mainContent.trigger("activePage",0),$("#homePage").fadeIn()}else n.notifyErrorMessage(e.code)},function(e){n.notifyErrorMessage(e.status)})})},y.prototype._addLoadingProcessAnimation=function(e){$("#mainModalContent").html(c.getDiv());var t=document.createElement("div");$(t).addClass("progressFileName"),$(t).css({"text-align":"center"}),$("#mainModalContent").append(t),$("#mainModalContent").find(".progressFileName").html(e)},y.prototype._getCloudSpaceInfo=function(){var e=this;a.querySpace(function(e){var t=e;$("#diskTotalSpace").html(t.total/1024),$("#diskUsedSpace").html(t.used/1024),$("#diskSpaceRadialBar").attr("data-label",(t.used*1/t.total*100).toFixed(1)+"%"),$("#diskSpaceRadialBar").attr("class","radial-bar radial-bar-"+parseInt((t.used*1/t.total*100/5).toFixed(0))*5+" radial-bar-lg radial-bar-info")},function(t){e.notifyErrorMessage(t.status)})},y.prototype._bindEvent=function(){this._bindDropZoneEvent()},y.prototype._bindDropZoneEvent=function(){var e=this,t=new Dropzone("#dropFileZone",{dictDefaultMessage:d+h.language.FileManagePage.DropToUpload,addRemoveLinks:!0});t.on("queuecomplete",function(){e.trigger("active")})},y.prototype.getContent=function(){var e=h.language.FileManagePage;return t.render(p,{FileManageText:e.FileManage,DropToUploadText:e.DropToUpload,TotalSpaceText:e.Total,UsedSpaceText:e.Used,DeleteButtonText:e.Delete,ExportButtonText:e.Export})},y});