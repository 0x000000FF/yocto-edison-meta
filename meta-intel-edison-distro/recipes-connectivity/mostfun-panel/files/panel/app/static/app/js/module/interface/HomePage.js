define(["require","mustache","lib/InheritHelper","lib/BrowserUtil","lib/DateTimeUtil","module/agent/HomePageAgent","module/agent/FileManagePageAgent","module/component/StatusCodeManager","module/component/TemperatureManager","module/interface/CentreContentPage","module/interface/kit/Loader","module/interface/kit/AlertBox","module/GlobalVar","text!../../../html/HomePage.html","text!../../../html/homePage/ControlPanel.html","text!../../../html/homePage/StatusPanel.html","text!../../../html/homePage/ControlSvg.html","text!../../../html/homePage/reprintableTable/TableBody.html"],function(e){"use strict";function w(){this.superClass();var e=document.getElementById("temperatureChart").getContext("2d");this._temperatureManager=new a(e),this._init(),this.bed=0,this.ex0=0}var t=e("mustache"),n=e("lib/InheritHelper"),r=e("lib/BrowserUtil"),i=e("lib/DateTimeUtil"),s=e("module/agent/HomePageAgent"),o=e("module/agent/FileManagePageAgent"),u=e("module/component/StatusCodeManager"),a=e("module/component/TemperatureManager"),f=e("module/interface/CentreContentPage"),l=e("module/interface/kit/Loader"),c=e("module/interface/kit/AlertBox"),h=e("module/GlobalVar"),p=e("text!../../../html/HomePage.html"),d=e("text!../../../html/homePage/ControlPanel.html"),v=e("text!../../../html/homePage/StatusPanel.html"),m=e("text!../../../html/homePage/ControlSvg.html"),g=e("text!../../../html/homePage/reprintableTable/TableBody.html"),y=3,b=!1;return n.inheritPrototype(w,f),w.prototype.INDEX=0,w.prototype.active=function(){this._temperatureManager.repaintSize()},w.prototype.getContent=function(){var e=h.language.HomePage,n={BedTargetTemperatureText:e.BedTargetTemperature,BedTemperatureText:e.BedTemperature,ExtruderTargetTemperatureText:e.ExtruderTargetTemperature,ExtruderTemperatureText:e.ExtruderTemperature,bedTargetTemperatureColor:a.prototype.BedTargetTemperatureColor,bedTemperatureColor:a.prototype.BedTemperatureColor,extruderTargetTemperatureColor:a.prototype.ExtruderTargetTemperatureColor,extruderTemperatureColor:a.prototype.ExtruderTemperatureColor};return t.render(p,{TemperatureInfoText:e.TemperatureInfo,GCodeControlText:e.GCodeControl,temperaturesInfo:n,MostFunControlPanelText:e.MostFunControlPanel,ControlPanel:t.render(d,{controlSvg:m,LevellingButtonText:e.Levelling,temperaturesInfo:n}),StatusPanel:t.render(v,{CurrentPrintFileText:e.CurrentPrintFile,CurrentPrintLayerText:e.CurrentPrintLayer,PrintPercentageText:e.PrintPercentage,SaveButtonText:h.language.SettingPage.Save,PauseButtonText:e.Pause,CancelButtonText:e.Cancel,ResumeButtonText:e.Resume}),SendButtonText:e.Send,ReprintableTableText:e.ReprintableTable,ReprintableFileNameText:e.ReprintableFileName,ReprintableFileCreatedDateText:e.ReprintableFileCreatedDate,ReprintableFileOperateText:e.ReprintableFileOperate})},w.prototype._init=function(){this._initChart(),this.disable(!1),h.isMobile&&($("#temperatureChart").hide(),$("#controlPanel").hide(),$("#gCodeControlPanel").hide()),this._initUpdateTimer(),this._bindEvent(),this.updataReprintTable()},w.prototype._initChart=function(){var e=this._temperatureManager;setTimeout(function(){e.repaintSize();for(var t=0,n=20;t<n;++t)e.addData({bedTemperature:0,bedSettingTemperature:0,e0Temperature:0,e0SettingTemperature:0,time:"hh/mm/ss"});setTimeout(function(){e.repaintSize()},2e3)},1200)},w.prototype.updataReprintTable=function(){var e=h.language.HomePage,n=this;$("#reprintableTableFooter").html(l.getDiv());if(h.debug){$("#reprintableTableBody").html(t.render(g,{reprintItems:[{name:"test1",date:"1970.2.2",flag:y,ReprintButtonText:e.Reprint,DeleteButtonText:e.Cancel},{name:"test2",date:"1970.2.2",flag:y,ReprintButtonText:e.Reprint,DeleteButtonText:e.Cancel}]})),$("#reprintableTableFooter").html(""),this._bindReprintableTableEvent();return}o.queryFile("backlist",function(r){var s=r,o=[],u=null;if(0===s.length){$("#reprintableTableRow").hide();return}for(var a=0,f=s.length;a<f;++a)u=s[a],o.push({name:u.fileName,date:i.getTimeZoneDate(u.fileTime),flag:y,ReprintButtonText:e.Reprint,DeleteButtonText:e.Cancel});$("#reprintableTableBody").html(t.render(g,{reprintItems:o})),$("#reprintableTableFooter").html(""),n._bindReprintableTableEvent()},function(e){n.notifyErrorMessage(e.status)})},w.prototype._bindReprintableTableEvent=function(){var e=h.language.AlertBoxError,t=this;$(".ReprintButton").each(function(){$(this).click(function(e){var n={filename:$(this).closest("tr").data("filename"),path:$(this).closest("tr").data("flag")};r.stopPropagation(e),o.operateFiles("/print/",n,function(e){u.isOK(e.code)?t.updataReprintTable():t.notifyErrorMessage(e.code)},function(e){t.notifyErrorMessage(e.status)})})}),$(".CancelReprintButton").each(function(){$(this).click(function(e){r.stopPropagation(e);var n={filename:$(this).closest("tr").data("filename").replace(/.gcode/,"")};o.operateFiles("/cancel-task/",n,function(e){u.isOK(e.code)?t.updataReprintTable():t.notifyErrorMessage(e.code)},function(e){t.notifyErrorMessage(e.status)})})})},w.prototype._initUpdateTimer=function(){var e=this._temperatureManager,t=!1,n=1e3,r=2e3,o=6e4,u=this;if(h.debug)var a={state:"printing",details:{fileName:"testFileName",layerNum:"layerNumber",layerCount:"90",percent:"60%"}};var f=0;setInterval(function(){if(h.debug){$("#gcodeLogWindow").prepend("["+i.formatDateToTime(new Date)+"] "+ ++f+" test<br>");if("ready"===a.state){if(!t)return;t=!1,$("#statusPanel").hide(),h.isMobile||$("#controlPanel").show(),$("#reprintableTableRow").show(),u.updataReprintTable();return}$("#currentPrintFile").html(a.details.fileName),$("#currentPrintLayer").html(a.details.layerNum),$("#printLayerCount").html(a.details.layerCount),$("#printPercentage").html(a.details.percent);if(t)return;t=!0,$("#controlPanel").hide(),$("#statusPanel").show(),$("#reprintableTableRow").hide();return}},3e3);if(h.debug)return;(function l(){s.queryGCodeLog(function(e){n=1e3,setTimeout(function(){l()},n*=2),typeof e=="string"&&(e=JSON.parse(e));var t=e;if(0===t.result.length)return;$.each(t.result,function(e){$("#gcodeLogWindow").prepend("["+i.formatDateToTime(new Date)+"] "+t.result[e].replace(/\n/g,"<br>"))})},function(e){u.notifyErrorMessage(e.status),setTimeout(function(){l()},n*=2),n=o<n?1e3:n})})(),function c(){s.queryPrint("temperature",function(t){e.updateData(t),r=2e3,setTimeout(function(){c()},r*=2)},function(e){u.notifyErrorMessage(e.status),setTimeout(function(){c()},r*=2),r=o<r?2e3:r})}()},w.prototype._bindEvent=function(){this._bindControlPanelEvent(),this._bindStatusPanelEvent()},w.prototype._bindControlPanelEvent=function(){var e=this;$("#levellingPlatformButton").click(function(t){r.stopPropagation(t),s.operatePrint("/auto-leveling/",function(t){u.isOK(t.code)||e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})}),$("#sendPanelCmdButton").click(function(){s.sendCmd($("#panelCmdText").val(),function(e){},function(t){e.notifyErrorMessage(t.status)})}),$("#activeBedTemperature").click(function(t){r.stopPropagation(t);if(!this.checked){s.sendCmd($("#bedTemperatureSliderNumber").data("cmd")+"0",function(){},function(t){e.notifyErrorMessage(t.status)});return}s.sendCmd($("#bedTemperatureSliderNumber").data("cmd")+$("#bedTemperatureSliderNumber").val(),function(){},function(t){e.notifyErrorMessage(t.status)})}),$("#activeExtruderTemperature").click(function(t){r.stopPropagation(t);if(!this.checked){s.sendCmd($("#extruderTemperatureSliderNumber").data("cmd")+"0",function(){},function(t){e.notifyErrorMessage(t.status)});return}s.sendCmd($("#extruderTemperatureSliderNumber").data("cmd")+$("#extruderTemperatureSliderNumber").val(),function(){},function(t){e.notifyErrorMessage(t.status)})}),$(".temperaturesSlider").each(function(){$(this).change(function(){var e=$("#"+$(this).data("inputid"));e[0].value=$(this).find("input")[0].value}),$(this).mouseup(function(t){if(!document.getElementById($(this).data("checkboxid")).checked)return;var n=$("#"+$(this).data("inputid")),r=$(this).find("input")[0].value;s.sendCmd(n.data("cmd")+r,function(){},function(t){e.notifyErrorMessage(t.status)})})}),$(".temperatureInput").each(function(){$(this).change(function(){if(!document.getElementById($(this).data("checkboxid")).checked)return;s.sendCmd($(this).data("cmd")+$(this).val(),function(){},function(t){e.notifyErrorMessage(t.status)})})}),$(".controlPanelButton").each(function(){$(this).click(function(t){r.stopPropagation(t);var n=$(this).data("cmd");s.sendCmd("G91",function(){s.sendCmd(n,function(e){s.sendCmd("G90",function(e){})})},function(t){e.notifyErrorMessage(t.status)})})})},w.prototype._bindStatusPanelEvent=function(){var e=this;$("#savePrintButton").click(function(){s.operatePrint("/save-task/",function(t){u.isOK(t.code)||e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})}),$("#pausePrintButton").click(function(){s.operatePrint("/pause/",function(t){u.isOK(t.code)||e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})}),$("#resumePrintButton").click(function(){s.operatePrint("/resume/",function(t){u.isOK(t.code)||e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})}),$("#cancelPrintButton").click(function(){s.operatePrint("/cancel/",function(t){u.isOK(t.code)||e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})})},w.prototype.updateStateInfo=function(e){if("error"==e.state){var t=new c(h.language.AlertBoxError.HardwareError);$("body").append(t.getDiv());return}"updating"===e.state&&(window.location.href="waiting-update");if("ready"===e.state){if(!b)return;b=!1,$("#statusPanel").hide(),h.isMobile||$("#controlPanel").show(),$("#reprintableTableRow").show(),this.updataReprintTable();return}$("#currentPrintFile").html(e.details.fileName),$("#currentPrintLayer").html(e.details.layerNum),$("#printLayerCount").html(e.details.layerCount),$("#printPercentage").html(e.details.percent.toFixed(2)+"%");if(b)return;b=!0,$("#controlPanel").hide(),$("#statusPanel").show(),$("#reprintableTableRow").hide()},w.prototype.update=function(){var e=new Date,t=null;if(h.debug){t={bedTemperature:Math.floor(Math.random()*60)+14,bedSettingTemperature:220,e0Temperature:Math.floor(Math.random()*60)+14,e0SettingTemperature:150},this._temperatureManager.addData({bedTemperature:t.bedTemperature,bedSettingTemperature:220,e0Temperature:t.e0Temperature,e0SettingTemperature:150,time:e.getMinutes()+":"+e.getSeconds()}),this._temperatureManager.repaintSize(),$("#bedTargetTemperature").html(220),$("#bedTemperature").html(t.bedTemperature),$("#extruderTargetTemperature").html(150),$("#extruderTemperature").html(t.e0Temperature);return}t=this._temperatureManager.getTemperatures(),$(".temperaturesSlider:eq(0) input").prop("value",t.extruderTargetTemperature),$("#extruderTemperatureSliderNumber").prop("value",t.extruderTargetTemperature),$(".temperaturesSlider:eq(1) input").prop("value",t.bedTargetTemperature),$("#bedTemperatureSliderNumber").prop("value",t.bedTargetTemperature),t.extruderTargetTemperature!=0&&$("#activeExtruderTemperature").attr("checked",!0),t.bedTargetTemperature!=0&&$("#activeBedTemperature").attr("checked",!0),this._temperatureManager.repaintData(e),this._temperatureManager.repaintSize(),$("#bedTargetTemperature").html(t.bedTargetTemperature),$("#bedTemperature").html(t.bedTemperature),$("#extruderTargetTemperature").html(t.extruderTargetTemperature),$("#extruderTemperature").html(t.extruderTemperature)},w});