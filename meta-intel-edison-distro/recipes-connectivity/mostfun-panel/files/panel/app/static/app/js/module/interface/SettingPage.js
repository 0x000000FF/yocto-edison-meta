define(["require","mustache","module/interface/CentreContentPage","lib/InheritHelper","lib/BrowserUtil","module/component/StatusCodeManager","module/interface/kit/Loader","module/agent/SettingPageAgent","module/GlobalVar","text!../../../html/SettingPage.html","text!../../../html/settingPage/PasswordSetting.html","text!../../../html/settingPage/FirmwareSetting.html","text!../../../html/settingPage/EmailSetting.html","text!../../../html/settingPage/WifiSetting.html","text!../../../html/settingPage/LanguageSetting.html","text!../../../html/settingPage/availableWifiTable/TableBody.html","text!../../../html/settingPage/wifiConnect/WifiOperateModal.html"],function(e){"use strict";function y(){this.superClass(),this._bindEvent(),this.active()}var t=e("mustache"),n=e("module/interface/CentreContentPage"),r=e("lib/InheritHelper"),i=e("lib/BrowserUtil"),s=e("module/component/StatusCodeManager"),o=e("module/interface/kit/Loader"),u=e("module/agent/SettingPageAgent"),a=e("module/GlobalVar"),f=e("text!../../../html/SettingPage.html"),l=e("text!../../../html/settingPage/PasswordSetting.html"),c=e("text!../../../html/settingPage/FirmwareSetting.html"),h=e("text!../../../html/settingPage/EmailSetting.html"),p=e("text!../../../html/settingPage/WifiSetting.html"),d=e("text!../../../html/settingPage/LanguageSetting.html"),v=e("text!../../../html/settingPage/availableWifiTable/TableBody.html"),m=e("text!../../../html/settingPage/wifiConnect/WifiOperateModal.html"),g=null;return r.inheritPrototype(y,n),y.prototype.INDEX=3,y.prototype.active=function(){this._upgradableCheck(),null===g&&(this._getCurrentWifi(),this._getCDNSetting())},y.prototype._upgradableCheck=function(){var e=this;u.queryData("/get-version/",function(t){if(s.isOK(t.code)){var n=t;$("#curPanelVersion").html(n.panel),$("#curSystemVersion").html(n.system)}else e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})},y.prototype._emailSettingUpdate=function(){var e=this;u.queryData("/get-mail-setting/",function(t){if(s.isOK(t.code)){var n=t;$("#nickname").val(n.nickname),$("#hostEmail").val(n.from_addr),$("#hostEmailPassword").val(n.password),$("#hostServer").val(n.smtp_server),$("#hostServerPort").val(n.port),$("#emailPrefix").val(n.prefix),$("#receiveEmail").val(n.to_addr),$("#emailSwitch")[0].checked="True"===n.mail_enabled?!0:!1}else e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})},y.prototype._getCurrentWifi=function(){var e=this;u.queryData("/get-current-wifi/",function(e){var t=e;$("#curWifiName").html(t.ssid+"("+t.ip+")")},function(t){$("#curWifiName").html(s.getErrorMessage(t.status)),e.notifyErrorMessage(t.status)})},y.prototype._bindEvent=function(){this._bindPasswordPageEvent(),this._bindFirmwarePageEvent(),this._bindEmailPageEvent(),this._bindWifiPageEvent(),this._bindLanguagePageEvent()},y.prototype._bindPasswordPageEvent=function(){var e=this;$("#savePasswordButton").click(function(t){i.stopPropagation(t);var n={old_password:$("#oldPassword").val(),new_password:$("#newPassword").val(),rpt_password:$("#confirmPassword").val()};u.changePassword(n,function(t){typeof t=="string"&&(t=JSON.parse(t));var n=t;s.isOK(n.code)?window.location.href=n.msg:e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})})},y.prototype._getCDNSetting=function(){var e=this;u.queryData("/get-cdn/",function(e){var t=e;$(".CDNSetting").each(function(){this.value==e["cdn"]&&(this.checked=!0)})},function(t){e.notifyErrorMessage(t.status)})},y.prototype._bindFirmwarePageEvent=function(){var e=this,t=function(){$("#firmwareSettingHeader").html(""),$("#firmwareSetting").find(".form-group").show()};$("#saveCDNButton").click(function(t){$("#CDNbody").css("display","none"),$("#CDNheader").css("display","block").html(o.getDiv()),i.stopPropagation(t),$(".CDNSetting").each(function(){if(!this.checked)return;var t={cdn:$(this).val()};u.changeCDN(t,function(t){$("#CDNbody").css("display","block"),$("#CDNheader").css("display","none"),s.isOK(t.code)?$(this).css("font-color","green"):e.notifyErrorMessage(t.code)},function(t){$("#CDNbody").css("display","block"),$("#CDNheader").css("display","none"),e.notifyErrorMessage(t.status)})})}),$("#testCDNButton").click(function(e){u.queryData("/test-cdn/",function(e){for(var t in e){var n="#speed_"+t;$(n).text(" - "+e[t]+"ms")}},function(e){})}),$("#doUpdateButton").click(function(n){u.queryData("/do-update/",function(n){s.isOK(n.code)||e.notifyErrorMessage(n.code),t()},function(n){t(),e.notifyErrorMessage(n.status)})}),$("#firmwareUpdateButton").click(function(n){$("#newsInfo").html(""),$("#firmwareSetting").find(".form-group").hide(),$("#firmwareSettingHeader").html(o.getDiv());var r=document.createElement("div");r.innerHTML=a.language.SettingPage.Update,$(r).css({"text-align":"center"}),$("#firmwareSettingHeader").append(r).append('<div style="text-align: center;"><strong id="processinfo"></strong></div>');var i=setInterval(function(){$.ajax({type:"GET",async:!0,url:"/get-update-process/",contentType:"application/x-www-form-urlencoded;charset=utf-8",success:function(e){typeof e=="string"&&(e=JSON.parse(e));var t=parseInt(e.process);$("#processinfo").html(a.language.UpdateProcess[t])}})},5e3);u.queryData("/chk-update/",function(n){t();if(s.isOK(n.code)){var r=n;if(n.length>0){$("#versionInfo").css("display","none"),$("#newsInfo").css("display","block").append('<div class = "form-group">');for(var i in n)$("#newsInfo").append('<label class = "col-lg-offset-3 col-lg-2 control-label">'+i+'</label><div class = "col-lg-6"><p class = "form-control-static">'+n[i]+"</p></div>");$("#newsInfo").append("</div>"),$("#doUpdateButton").removeAttr("disabled")}}else e.notifyErrorMessage(n.code)},function(n){t(),e.notifyErrorMessage(n.status)}),clearInterval(i)})},y.prototype._bindEmailPageEvent=function(){var e=this;$("#emailSettingTab").click(function(t){e._emailSettingUpdate()}),$("#emailSwitch").click(function(t){i.stopPropagation(t);var n={enabled:this.checked};u.setEmailNotify(n,function(t){s.isOK(t.code)||e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})}),$("#saveEmailButton").click(function(t){i.stopPropagation(t),$("#emailSettingBody").css("display","none"),$("#emailSettingHeader").css("display","block").html(o.getDiv());var n={nickname:$("#nickname").val(),from_addr:$("#hostEmail").val(),password:$("#hostEmailPassword").val(),smtp_server:$("#hostServer").val(),port:$("#hostServerPort").val(),prefix:$("#emailPrefix").val(),to_addr:$("#receiveEmail").val()};u.changeEmail(n,function(t){s.isOK(t.code)||e.notifyErrorMessage(t.code),$("#emailSettingBody").css("display","block"),$("#emailSettingHeader").css("display","none")},function(t){e.notifyErrorMessage(t.status)})})},y.prototype._bindWifiPageEvent=function(){var e=this;$("#saveRouterSettingButton").click(function(t){i.stopPropagation(t);var n={ssid:$("#routerName").val(),password:$("#routerPassword").val()};u.changeRouter(n,function(t){s.isOK(t.code)||e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})}),$("#getAvailableWifiButton").click(function(t){i.stopPropagation(t),$("#wifiTableFooter").html(o.getDiv()),$("#availableWifiTableBody").html("");if(a.debug){var n=[{ssid:"name",numberID:2,db:-8,secure:"secure"},{ssid:"name2",numberID:12,db:-18,secure:"secure2"}];e._setWifiListTable(n);return}u.queryData("/get-wireless-list/",function(t){s.isOK(t.code)?e._setWifiListTable(t):e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})})},y.prototype._setWifiListTable=function(e){var n=[],r=null,s=this;for(var o=0,u=e.length;o<u;++o)r=e[o],n.push({name:r.ssid,numberID:o,strength:(100+parseFloat(r.db)).toFixed(2),protocol:r.secure,connectText:a.language.SettingPage.Connect});$("#wifiTableFooter").html(""),$("#availableWifiTableBody").html(t.render(v,{wifiItems:n})),$(".ConnectWifiButton").each(function(){$(this).click(function(e){i.stopPropagation(e),s._onConnectButtonClick($(this).closest("tr").data("wifiname"),$(this).closest("tr").data("numberid"),$(this).closest("tr").data("protocol"))})})},y.prototype._onConnectButtonClick=function(e,n,r){var i=a.language.SettingPage;"OPEN"==r?($("#mainModal").modal("show"),$("#mainModalContent").html(t.render(m,{ConnectText:i.Connect})),setTimeout(this._bindWifiConnectEvent(e,n,r,""),100)):($("#mainModalContent").html(t.render(m,{ConnectText:i.Connect,SaveButtonText:i.Save,wifiNameText:e,WifiPasswordCharactersRequiresText:i.WifiPasswordCharactersRequires})),$("#mainModal").modal("show"),this._bindWifiConnectModalEvent(e,n,r))},y.prototype._bindWifiConnectModalEvent=function(e,t,n){var r=this;$("#wifi_ConnectButton").click(function(s){if(8>$("#wifiPassword").val().length){$("#wifiPasswordCharactersRequires").show();return}i.stopPropagation(s),$("#wifiPasswordCharactersRequires").hide(),r._bindWifiConnectEvent(e,t,n,$("#wifiPassword").val())})},y.prototype._bindWifiConnectEvent=function(e,t,n,r){var i=this;$("#connectinput").css("display","none"),$("#connectload").css("display","block").html(o.getDiv()),clearTimeout(g);var a={ssid:e,number:t,secure:n,password:r},f=$.Deferred(),l=u.connectWifi(a,function(e){s.isOK(e.code)||i.notifyErrorMessage(e.code)},function(e){i.notifyErrorMessage(e.status)},function(){$("#mainModal").modal("hide"),$("#connectinput").css("display","block"),$("#connectload").css("display","none")});g=setTimeout(function(){$("#curWifiName").html(o.getDiv()),i._getCurrentWifi(),g=null},5e3)},y.prototype._bindLanguagePageEvent=function(){var e=this;$("#saveLanguageButton").click(function(t){i.stopPropagation(t),$(".languageSetting").each(function(){if(!this.checked)return;var t={lang:$(this).val()};u.changeLanguage(t,function(t){s.isOK(t.code)?location.reload(!0):e.notifyErrorMessage(t.code)},function(t){e.notifyErrorMessage(t.status)})})})},y.prototype.getContent=function(){var e=a.language.SettingPage;return t.render(f,{SettingText:e.Setting,PasswordSettingText:e.PasswordSetting,FirmwareSettingText:e.FirmwareSetting,EmailSettingText:e.EmailSetting,WifiSettingText:e.WifiSetting,passwordSetting:t.render(l,{OldPasswordText:e.OldPassword,NewPasswordText:e.NewPassword,ConfirmPasswordText:e.ConfirmPassword,SaveButtonText:e.Save}),firmwareSetting:t.render(c,{CurPanelVersionText:e.CurPanelVersion,CurSystemVersionText:e.CurSystemVersion,UpdateButtonText:e.Update,doUpdateButtonText:e.doUpdate,chineseCDN:e.chineseCDN,hongkongCDN:e.hongkongCDN,europeCDN:e.europeCDN,usaCDN:e.usaCDN,testCDNButtonText:e.testCDNButtonText,saveCDNButtonText:e.saveCDNButtonText}),emailSetting:t.render(h,{NicknameText:e.Nickname,HostEmailText:e.HostEmail,HostEmailPasswordText:e.HostEmailPassword,HostEmailServerText:e.HostEmailServer,HostServerText:e.HostServer,HostServerPortText:e.HostServerPort,EmailPrefixText:e.EmailPrefix,ReceiveEmailText:e.ReceiveEmail,EmailSwitchText:e.EmailSwitch,SaveButtonText:e.Save}),wifiSetting:t.render(p,{CurWifiConnectionText:e.CurWifiConnection,RouterSettingText:e.RouterSetting,RouterNameText:e.RouterName,RouterPasswordText:e.RouterPassword,AvailableWifiText:e.AvailableWifi,WifiNameText:e.WifiName,WifiStrengthText:e.WifiStrength,EncryptionProtocolText:e.EncryptionProtocol,ConnectText:e.Connect,SaveButtonText:e.Save}),languageSetting:t.render(d,{SaveButtonText:e.Save})})},y});